<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8">
    <title>Character Sheet</title>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
</head>
    
<body>
    <top>
        <name id=name>
        <div id=charname>
        </div>
        </name><br>
        <info id=info>
        </info><br>
    </top>
        
    <col1>
      <subcol1>
        <abilityscores>
            <abilityscore id=abilityscore>
            </abilityscore><br>
        </abilityscores>
      </subcol1>
      <subcol2>
        <inspiration id=inspiration>
            Inspiration
        </inspiration><br>
        <proficiencybonus id=proficiencybonus>
            Proficiency Bonus
        </proficiencybonus><br>
        <savingthrows id=savingthrows>
            Saving Throws<br>
        </savingthrows><br>
        <skill id=skill>
            Skills<br>
        </skill><br>
      </subcol2> 
    </col1>
    <br><br><br><br><br>
    <button type=button id=downloadbutton>Save File</button><br>
    <input type="file" id="fileInput">
</body>

<script>
//how to use: insert fields into the character variable, and locations for each field in to the locations variable. match via index. each character field NEEDS a location field. script then automatically creates inputs for each character field and assigns them to a div by ID based on the location.
var character = 'CharacterName,Level,Class,Race,PlayerName,ExperiencePonts,Alignment,Background,Strength,Dexterity,Constitution,Intelligence,Wisdom,Charisma,Inspiration,ProficiencyBonus,StrengthSave,DexteritySave,ConstitutionSave,IntelligenceSave,WisdomSave,CharismaSave,Acrobatics,AnimalHandling,Arcana,Athletics,Deception,History,Insight,Intimidation,Investigation,Medicine,Nature,Perception,Performance,Persuasion,Religion,SleightofHand,Stealth,Survival'.split(',');
    var locations = 'name,info,info,info,info,info,info,info,abilityscore,abilityscore,abilityscore,abilityscore,abilityscore,abilityscore,inspiration,proficiencybonus,savingthrows,savingthrows,savingthrows,savingthrows,savingthrows,savingthrows,skill,skill,skill,skill,skill,skill,skill,skill,skill,skill,skill,skill,skill,skill,skill,skill,skill,skill'.split(',');
    var label = 'CharacterName,Level,Class,Race,PlayerName,ExperiencePonts,Alignment,Background,Strength,Dexterity,Constitution,Intelligence,Wisdom,Charisma,Inspiration,ProficiencyBonus,Strength,Dexterity,Constitution,Intelligence,Wisdom,Charisma,Acrobatics (Dex),Animal Handling (Wis),Arcana (Int),Athletics (Str),Deception (Cha),History (Int),Insight (Wis),Intimidation (Cha),Investigation (Int),Medicine (Wis),Nature (Int),Perception (Wis),Performance (Cha),Persuasion (Cha),Religion (Int),Sleight of Hand (Dex),Stealth (Dex),Survival (Wis)'.split(',');
    var mods = new Array();
    var loccount = 0; //hack to iterate through locations because [c] wouldn't work for some reason.
    for (var c in character) { //for each index in character, do the following
        var newField = document.createElement('input'); //creates input element in the document
        var loc = locations[loccount]; //gets the location that corresponds to the same index as the current character value
        newField.id = character[c]; //assigns it an ID from character
        newField.className = loc; //assigns classname from location
        newField.placeholder = character[c]; //assigns placeholder text from character
        newField.name = character[c]; //assigns name from character
        loccount++ //iterates loccount
        var elem = document.getElementById(loc); //gets element by matching its ID to the location
        elem.appendChild(newField); //adds the new input field to the location element
        if (loc == "skill" || loc == "savingthrows" || loc == "abilityscore") {
        		var newmod = document.createElement('input');
            newmod.className = loc + "mod";
            newmod.mod = true;
            newmod.id = character[c] + "mod";
            mods.push(character[c] + "mod");
            elem.appendChild(newmod);
        }
        if (loc == "skill" || loc == "savingthrows") {
            newField.type = 'checkbox';
            var newlabel=document.createElement("Label");
            var newbr=document.createElement("br");
            newlabel.setAttribute("for",character[c]);
            newlabel.innerHTML = label[c];
            elem.appendChild(newlabel);
            newlabel.appendChild(newbr);
        }
        }

//download button function
document.getElementById("downloadbutton").addEventListener("click", function(){ //adds an event listener to the Download Button, runs function on click.
    var characterfinal = {}; //creates characterfinal object
    for (var d in character) { //for each index in character, do the following
    		prop = character[d]; //assigns current index value from character to the prop variable
        if (document.getElementById(prop).type == "checkbox") {
            elem = document.getElementById(prop).checked;
        } else {elem = document.getElementById(prop).value;} //gets value of element by ID using each field in character object. The elements themselves are created from the character object to begin with, so this will always get all of the fields on the page.
        characterfinal[prop] = elem; //creates key in characterfinal object named from character values, then assigns it a value based on the value of the same field on the page.
    }
    for (var m in mods) {
    	propmod = mods[m];
      elemmod = document.getElementById(propmod).value;
      characterfinal[propmod] = elemmod;
    }
    var text = JSON.stringify(characterfinal, null, 2); //turns the completed characterfinal object into a string for saving, forgot what null does but 2 specifies that it should include line breaks. Assigns it to the text variable, this is printed in the .txt file body.
    var filename = document.getElementById('CharacterName').value; //gets a name for the file from the Character Name field.
    download(text, filename); //calls download function, below, using text and filename options.
}, false); //forgot what this false was for.

//function to actually download the text
function download(text, filename) {
    var element = document.createElement('a'); //creates an element named a 
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text)); //assigns the element the text field and link attributes
    element.setAttribute('download', filename + ".txt"); //adds download attribute with filename and .txt for firefox.
    element.style.display = 'none'; //makes element hidden
    document.body.appendChild(element); //add element to the page
    element.click(); //clicks the element automatically 
    document.body.removeChild(element); //removes the element
}

//upload button function
var fileInput = document.getElementById('fileInput'); //gets fileInput field, aka the upload button
var fileDisplayArea = document.getElementById('CharacterName'); //sets CharacterName to be the filedisplayarea. Just used for error printing.

fileInput.addEventListener('change', function(event) { //checks if the fileInput field is changed, aka if a file is uploaded
    var file = fileInput.files[0]; //gets 1st file from fileInput field
    var textType = /text.*/; //assigns text as filetype var
    if (file.type.match(textType)) { //if filetype matches text, go ahead and load
				var reader = new FileReader(); //creates new FileReader thingy
				reader.onload = function(event) { //when reader loads, do the following
                    for (var e in character) { //for each index of e in character, do the following
                        var field = character[e]; //field is equal to the current index value of the character object
                        var loadedcharacter = JSON.parse(reader.result); //parses the text file back into an object, assigned to loadedcharacter var
                        if (document.getElementById(field).type == "checkbox") {
                            document.getElementById(field).checked = loadedcharacter[field];
                        } else {document.getElementById(field).value = loadedcharacter[field];} //assigns values from the loadedcharacter object to the corresponding elements on the page by their IDs. 
                    }
                    for (var n in mods) {
                    	var fieldmod = mods[n];
                      document.getElementById(fieldmod).value = loadedcharacter[fieldmod];
                    }
				}
    reader.readAsText(file); //reads the file. not sure if this is needed or not since it comes after the actual parsing. 
    fileInput.value = ""; //clears the input file after its done loading
	} else { fileDisplayArea.innerText = "File not supported!" } //if not match, error
});

//section for autocalcs

var level = document.getElementById('Level');
var prof = document.getElementById('ProficiencyBonus');
level.addEventListener('change', function() {
if (level.value >= 1 && level.value <= 4) {
prof.value = 2;
} else if (level.value >= 5 && level.value <= 8) {
prof.value = 3;
} else if (level.value >= 9 && level.value <= 12) {
prof.value = 4;
} else if (level.value >= 13 && level.value <= 16) {
prof.value = 5;
} else if (level.value >= 17 && level.value <= 20) {
prof.value = 6;
} else {prof.value = "";}
});
</script>